<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <script src="https://tts2.ap.qlikcloud.com/resources/assets/external/requirejs/require.js"></script>
  <link rel="stylesheet" href="https://tts2.ap.qlikcloud.com/resources/autogenerated/qlik-styles.css">

<script>
//Qlik Sense SaaSのテナント情報
var server = {
  host: "tts2.ap.qlikcloud.com", // Qlik Sense SaaS tenant
  port: 443,                     // Qlik Sense SaaS port
  prefix: "/",                   // Virtual Proxy prefix
  isSecure: true,                // true=https, false=http
  webIntegrationId: 'Jrh8kjVXnikS9GteYCldwL5INe36hcVG' // Web ID
};

//認証済みかのチェック
function connect() {
  var tenant = "https://"+server.host+(server.port ? ":"+server.port : "");
  //ログイン状態チェック用API: https://[tenant]/api/v1/users/me
  fetch(tenant + "/api/v1/users/me", {
    method: "GET",
    mode: "cors",           // no-cors, cors, same-origin
    credentials: "include", // include, same-origin, omit
    headers: {
      "qlik-web-integration-id": server.webIntegrationId
    }
  }).then(response => {
    //未認証の場合はQlik Sense SaaSのログイン画面にリダイレクト
    //https://[tenant]/login?returnto=https://xxx&qlik-web-integration-id=xxx
    if(response.status===401) {
      var url = tenant + "/login";
      url = url + '?returnto=' + encodeURIComponent(window.location.href);
      url = url + '&qlik-web-integration-id=' + server.webIntegrationId;
      window.location.href = url;
    }
    else if(response.status===200) {
      alert("認証して戻ってきました!!");
      start();
    }
  }).catch(error => {
    alert(error);
  });
}
connect(); //認証済みかのチェック

function start() {
require.config({
  baseUrl: "https://" + server.host + (server.port ? ":" + server.port : "") + server.prefix + "resources",
  webIntegrationId: server.webIntegrationId
});
require(["js/qlik", "jquery"], function(qlik, $) {
  qlik.setLanguage('ja-JP');                           // 表示言語
  qlik.theme.apply('breeze');                          // Theme ID
  var app_id = '58966ad8-c483-4fac-9d71-769c75458740'; // App ID
  var app = qlik.openApp(app_id, server);
  app.getObject('QV01', 'CurrentSelections'); // 選択バー
  app.getObject('QV03', 'BDQru'); // フィルターパネル(支店名)

  // ListObjectの生成
  app.createList({
    "qDef": { "qFieldDefs": ["支店名"], "qFieldLabels": ["支店名"] },
    "qLibraryId": null, // マスターアイテムID
    "qFrequencyMode": "V",
    "qExpressions": []
  }).then(function(model) {
    // ListObjectの生成後
    var width = model.layout.qListObject.qSize.qcx;
    var height = (width==0) ? 1 : Math.floor(10000 / width);
    model.layout.qListObject.qDataPages = [];
    getAllList(width, height, 0);
    function getAllList(w, h, lr) {
      var requestPage = [{qTop: lr, qLeft: 0, qWidth: w, qHeight: h}];
      model.getListObjectData('/qListObjectDef',requestPage).then(function(dataPages) {
        model.layout.qListObject.qDataPages.push(dataPages[0]);
        var n = dataPages[0].qMatrix.length;
        if(lr + n >= model.layout.qListObject.qSize.qcy) {
          renderingList();
          return;
        }
        getAllList(w, h, lr + n);
      });
    }
    // リストが再計算されたイベントをキャッチ
    model.Validated.bind(function() {
      model.layout.qListObject.qDataPages = [];
      getAllList(width, height, 0);
    });
    // 全ListデータをHTMLにレンダリング
    function renderingList() {
      //console.log(model.layout.qListObject);
      var hc = model.layout.qListObject, allListPages = hc.qDataPages;
      var html = '';
      html += hc.qDimensionInfo.qFallbackTitle + '<br>';
      html += '<select size="7" id="list1" multiple>';
      for(let p of allListPages) {
        for(var r = 0; r < p.qMatrix.length; r++) {
          for(var c = 0; c < p.qMatrix[r].length; c++) {
            var cell = p.qMatrix[r][c];
            html += '<option value="' + cell.qElemNumber + '"';
            if(cell.qState=="S")
              html += ' selected';
            html += '>';
            if( cell.qElemNumber == -2 )
              html += '-';
            else if( cell.hasOwnProperty('qText') )
              html += cell.qText;
            else if( cell.hasOwnProperty('qNum') )
              html += cell.qNum;
            else
              html += '' + ',';
            html += '</option>';
          }
        }
      }
      html += '</select>';
      $("#QV02").html(html);
      $("#list1").on('change',(e)=>{
        var ids = $(e.target).val().map((e)=>{return parseInt(e,10);});
        var field = app.field(hc.qDimensionInfo.qGroupFieldDefs[0]);
        field.select(ids, false);
      });
    }
  });

  // HyperCubeの生成
  app.createCube({
    "qDimensions": [{
      "qDef": { "qFieldDefs": ["営業員名"], "qFieldLabels": ["営業員名"] },
      "qNullSuppression": true,
      "qOtherTotalSpec": {
        "qOtherMode": "OTHER_OFF",
        "qSuppressOther": true,
        "qOtherSortMode": "OTHER_SORT_DESCENDING",
        "qOtherCounted": { "qv": "5" },
        "qOtherLimitMode": "OTHER_GE_LIMIT"
      }
    }],
    "qMeasures": [{
      "qDef": { "qDef": "Sum([販売価格])", "qLabel": "実績",
                "qNumFormat": {"qType": "M", "qUseThou": 1, "qThou": ","} },
      "qLibraryId": null, // マスターアイテムID
      "qSortBy": {
        "qSortByState": 0,
        "qSortByFrequency": 0,
        "qSortByNumeric": -1, // ソート: 0=無し, 1=昇順, -1=降順
        "qSortByAscii": 0,
        "qSortByLoadOrder": 0,
        "qSortByExpression": 0,
        "qExpression": { "qv": " " }
      }
    }],
    "qSuppressZero": false,
    "qSuppressMissing": false,
    "qMode": "S",
    "qInterColumnSortOrder": [1,0], // ソート順: 1=実績, 0=営業員名
    "qStateName": "$"
  }).then(function(model) {
    // HyperCubeの生成後
    var width = model.layout.qHyperCube.qSize.qcx;
    var height = (width==0) ? 1 : Math.floor(10000 / width);
    model.layout.qHyperCube.qDataPages = [];
    getAllData(width, height, 0);
    function getAllData(w, h, lr) {
      var requestPage = [{qTop: lr, qLeft: 0, qWidth: w, qHeight: h}];
      model.getHyperCubeData('/qHyperCubeDef',requestPage).then(function(dataPages) {
        model.layout.qHyperCube.qDataPages.push(dataPages[0]);
        var n = dataPages[0].qMatrix.length;
        if(lr + n >= model.layout.qHyperCube.qSize.qcy) {
          renderingHyperCube();
          return;
        }
        getAllData(w, h, lr + n);
      });
    }
    // 集計データが再計算されたイベントをキャッチ
    model.Validated.bind(function() {
      model.layout.qHyperCube.qDataPages = [];
      getAllData(width, height, 0);
    });
    // 全セルデータをHTMLにレンダリング
    function renderingHyperCube() {
      //console.log(model.layout.qHyperCube);
      var hc = model.layout.qHyperCube, allDataPages = hc.qDataPages;
      var table = '';
      table += '<table border="1"><thead><tr>';
      for(let dim of hc.qDimensionInfo)
        table += '<th>' + dim.qFallbackTitle + '</th>';
      for(let mes of hc.qMeasureInfo)
        table += '<th>' + mes.qFallbackTitle + '</th>';
      table += '</tr></thead><tbody>';
      for(let p of allDataPages) {
        for(var r = 0; r < p.qMatrix.length; r++) {
          table += '<tr>';
          for(var c = 0; c < p.qMatrix[r].length; c++) {
            var cell = p.qMatrix[r][c];
            if( cell.qElemNumber == -2 )
              table += '<td>' + '-' + '</td>';
            else if( cell.hasOwnProperty('qText') )
              table += '<td>' + cell.qText + '</td>';
            else if( cell.hasOwnProperty('qNum') )
              table += '<td>' + cell.qNum + '</td>';
            else
              table += '<td>' + '' + '</td>';
          }
          table += '</tr>';
        }
      }
      $("#QV04").html(table);
    }
  });

  window.onbeforeunload = function() {
    app.close();
  }
});
}
</script>

</head>

<body>

<table border="1" width="100%" height="100%">
  <tbody>
    <tr>
      <td colspan="3" width="100%" height="10%"><div id="QV01" style="width:100%;height:100%;"></div></td>
    </tr>
    <tr>
      <td width="30%" height="45%"><div id="QV02" style="width:100%;height:100%;"></div></td>
      <td colspan="2" rowspan="2" width="70%" height="80%"><div id="QV04" style="width:100%;height:100%;overflow-y:scroll;"></div></td>
    </tr>
    <tr>
      <td width="30%" height="45%"><div id="QV03" style="width:100%;height:100%;"></div></td>
    </tr>
  </tbody>
</table>

</body>
</html>
